<!DOCTYPE html>
<html>
<head>
	<title>Facebook Frame</title>
	
  <style>
    body,h1,h2,p,div,form,ul,li {
      margin:0px;
      padding:0px;
      font-size:12px;
    }
    
    body {
      background:grey;
    }
	
		div#header {
			background: #3B5998;
      height:50px;
      margin-right:201px;
		}
    
    div#canvas-outer {
      margin-right:201px;
    }
    
    div#canvas-wrapper {
      margin-left:auto;
      margin-right:auto;
      height:250px;
      background:white;
    }
    
    body.canvas_fixed div#canvas-wrapper {
      width:720px;
    } 
    body.page_narrow div#canvas-wrapper {
      width:520px;
    }
    body.page_wide div#canvas-wrapper {
      width:850px;
    }
    
    
    /* show/hide page settings in right col depending on embed mode */
    div#page_settings {
      display:none
    }
    body.page_wide div#page_settings,
    body.page_narrow div#page_settings {
      display:block;
    }
		
	  div#right-col {
      border-left:1px solid #ddd;
      overflow-y: auto;
      background:white;
      width:200px;
      position:absolute;
      height:100%;
      right:0px;
      top:0px;
    }
	
	form input, form label, form select {
		display:block
	}
	
	form input, form select {
		margin-bottom:10px;
	}

	form input[type="text"] {
		width: 90%;
	}

	</style>
  
</head>
<body class="canvas_fluid">
	<div id="header">
		<h1>Facebook Frame</h1>
	</div>
	<div id="canvas-outer">
  	<div id="canvas-wrapper">
      <!-- The iframe into which the app is loaded -->
  		<iframe id="canvas-frame" width="100%" height="100%" frameborder=0></iframe>
  	</div>
  </div>
  
  <!-- Form which actually submits to the iframe -->
  <form id="post-form" method="POST" action="" target="canvas-frame">
    <input type="hidden" id="signed_request" name="signed_request" />
  </form>
	
	<div id="right-col">
		
		<select id="embed_mode">
			<option selected value="canvas_fluid">Canvas Fluid Width</option>
      <option value="canvas_fixed">Canvas 780px</option>
			<option value="page_narrow">Page Tab 520px</option>
			<option value="page_wide">Page Tab 850px</option>
		</select>
		
		<form id="config-form">
			
			<h2>App Settings</h2>
			
			<label for="config_app_secret">App Secret</label>
            <input type="text" id="config_app_secret" value="34534534534" placeholder="App Secret as shown in your app's settings"/>
			
			<label for="config_server_url">Server URL</label>
			<input type="text" id="config_server_url" value="http://localhost:3000/"placeholder="The base URL to which POST requests should be sent"/>
			
			<label for="config_canvas_path">Canvas Path</label>
			<input type="text" id="config_canvas_path_prefix" value="https://apps.facebook.com/yournamespace/" />
			<input type="text" id="config_canvas_path" value="debug_signed_request" placeholder="" />
			
      <div id="page_settings">
  			<h2>Page Settings</h2>
  			<label for="config_page_id">Page ID</label>
  			<input type="text" id="config_page_id" value="123456"placeholder="The ID of the page in which the iframe is embedded"/>
      </div>
      
      
      <h2>User Settings</h2>
			
			<label for="config_user_id">User ID</label>
			<input type="text" id="config_user_id" value="605665581" placeholder="The User ID the request is coming from. Leave blank to simulate un-auth'd user"/>
			
			
      <label for="config_country">User Country</label>
	    <select id="config_country">
		    <option value="af">af</option><option value="ax">ax</option><option value="al">al</option><option value="dz">dz</option><option value="ad">ad</option><option value="ao">ao</option><option value="ai">ai</option><option value="aq">aq</option><option value="ag">ag</option><option value="ar">ar</option><option value="am">am</option><option value="aw">aw</option><option value="au">au</option><option value="at">at</option><option value="az">az</option><option value="bs">bs</option><option value="bh">bh</option><option value="bd">bd</option><option value="bb">bb</option><option value="by">by</option><option value="be">be</option><option value="bz">bz</option><option value="bj">bj</option><option value="bm">bm</option><option value="bt">bt</option><option value="bo">bo</option><option value="bq">bq</option><option value="ba">ba</option><option value="bw">bw</option><option value="bv">bv</option><option value="br">br</option><option value="io">io</option><option value="bn">bn</option><option value="bg">bg</option><option value="bf">bf</option><option value="bi">bi</option><option value="kh">kh</option><option value="cm">cm</option><option value="ca">ca</option><option value="cv">cv</option><option value="ky">ky</option><option value="cf">cf</option><option value="td">td</option><option value="cl">cl</option><option value="cn">cn</option><option value="cx">cx</option><option value="cc">cc</option><option value="co">co</option><option value="km">km</option><option value="cg">cg</option><option value="cd">cd</option><option value="ck">ck</option><option value="cr">cr</option><option value="ci">ci</option><option value="hr">hr</option><option value="cu">cu</option><option value="cw">cw</option><option value="cy">cy</option><option value="cz">cz</option><option value="dk">dk</option><option value="dk">dk</option><option value="dm">dm</option><option value="do">do</option><option value="ec">ec</option><option value="eg">eg</option><option value="sv">sv</option><option value="gq">gq</option><option value="er">er</option><option value="ee">ee</option><option value="et">et</option><option value="fk">fk</option><option value="fo">fo</option><option value="fj">fj</option><option value="fi">fi</option><option value="fr">fr</option><option value="gf">gf</option><option value="pf">pf</option><option value="tf">tf</option><option value="ga">ga</option><option value="gm">gm</option><option value="ge">ge</option><option value="dm">dm</option><option value="gh">gh</option><option value="gi">gi</option><option value="gr">gr</option><option value="gl">gl</option><option value="gd">gd</option><option value="gp">gp</option><option value="gu">gu</option><option value="gt">gt</option><option value="gg">gg</option><option value="gn">gn</option><option value="gw">gw</option><option value="gy">gy</option><option value="ht">ht</option><option value="hm">hm</option><option value="va">va</option><option value="hn">hn</option><option value="hk">hk</option><option value="hu">hu</option><option value="is">is</option><option value="in">in</option><option value="id">id</option><option value="ir">ir</option><option value="iq">iq</option><option value="ie">ie</option><option value="im">im</option><option value="il">il</option><option value="it">it</option><option value="jm">jm</option><option value="jp">jp</option><option value="je">je</option><option value="jo">jo</option><option value="kz">kz</option><option value="ke">ke</option><option value="ki">ki</option><option value="kp">kp</option><option value="kr">kr</option><option value="kw">kw</option><option value="kg">kg</option><option value="la">la</option><option value="lv">lv</option><option value="lb">lb</option><option value="ls">ls</option><option value="lr">lr</option><option value="ly">ly</option><option value="li">li</option><option value="lt">lt</option><option value="lu">lu</option><option value="mo">mo</option><option value="mk">mk</option><option value="mg">mg</option><option value="mw">mw</option><option value="my">my</option><option value="mv">mv</option><option value="ml">ml</option><option value="mt">mt</option><option value="mh">mh</option><option value="mq">mq</option><option value="mr">mr</option><option value="mu">mu</option><option value="yt">yt</option><option value="mx">mx</option><option value="fm">fm</option><option value="md">md</option><option value="mc">mc</option><option value="mn">mn</option><option value="me">me</option><option value="ms">ms</option><option value="ma">ma</option><option value="mz">mz</option><option value="mm">mm</option><option value="na">na</option><option value="nr">nr</option><option value="np">np</option><option value="nl">nl</option><option value="nc">nc</option><option value="nz">nz</option><option value="ni">ni</option><option value="ne">ne</option><option value="ng">ng</option><option value="nu">nu</option><option value="nf">nf</option><option value="mp">mp</option><option value="no">no</option><option value="om">om</option><option value="pk">pk</option><option value="pw">pw</option><option value="ps">ps</option><option value="pa">pa</option><option value="pg">pg</option><option value="py">py</option><option value="pe">pe</option><option value="ph">ph</option><option value="pn">pn</option><option value="pl">pl</option><option value="pt">pt</option><option value="pr">pr</option><option value="qa">qa</option><option value="re">re</option><option value="ro">ro</option><option value="ru">ru</option><option value="rw">rw</option><option value="bl">bl</option><option value="sh">sh</option><option value="kn">kn</option><option value="lc">lc</option><option value="mf">mf</option><option value="pm">pm</option><option value="vc">vc</option><option value="ws">ws</option><option value="sm">sm</option><option value="st">st</option><option value="sa">sa</option><option value="sn">sn</option><option value="rs">rs</option><option value="sc">sc</option><option value="sl">sl</option><option value="sg">sg</option><option value="sx">sx</option><option value="sk">sk</option><option value="si">si</option><option value="sb">sb</option><option value="so">so</option><option value="za">za</option><option value="gs">gs</option><option value="ss">ss</option><option value="es">es</option><option value="lk">lk</option><option value="sd">sd</option><option value="sr">sr</option><option value="sj">sj</option><option value="sz">sz</option><option value="se">se</option><option value="ch">ch</option><option value="sy">sy</option><option value="tw">tw</option><option value="tj">tj</option><option value="tz">tz</option><option value="th">th</option><option value="tl">tl</option><option value="tg">tg</option><option value="tk">tk</option><option value="to">to</option><option value="tt">tt</option><option value="tn">tn</option><option value="tr">tr</option><option value="tm">tm</option><option value="tc">tc</option><option value="tv">tv</option><option value="ug">ug</option><option value="ua">ua</option><option value="ae">ae</option><option value="gb">gb</option><option selected value="us">us</option><option value="um">um</option><option value="uy">uy</option><option value="uz">uz</option><option value="uv">uv</option><option value="ve">ve</option><option value="vn">vn</option><option value="vg">vg</option><option value="vi">vi</option><option value="wf">wf</option><option value="eh">eh</option><option value="ye">ye</option><option value="zm">zm</option><option value="zw">zw</option>		 
	    </select>
	  
	    <label for="config_locale">User Locale</label>
      <select id="config_locale">
		    <option value="af_ZA">af_ZA</option><option value="ar_AR">ar_AR</option><option value="az_AZ">az_AZ</option><option value="be_BY">be_BY</option><option value="bg_BG">bg_BG</option><option value="bn_IN">bn_IN</option><option value="bs_BA">bs_BA</option><option value="ca_ES">ca_ES</option><option value="cs_CZ">cs_CZ</option><option value="cy_GB">cy_GB</option><option value="da_DK">da_DK</option><option value="de_DE">de_DE</option><option value="el_GR">el_GR</option><option value="en_GB">en_GB</option><option value="en_PI">en_PI</option><option value="en_UD">en_UD</option><option selected value="en_US">en_US</option><option value="eo_EO">eo_EO</option><option value="es_ES">es_ES</option><option value="es_LA">es_LA</option><option value="et_EE">et_EE</option><option value="eu_ES">eu_ES</option><option value="fa_IR">fa_IR</option><option value="fb_LT">fb_LT</option><option value="fi_FI">fi_FI</option><option value="fo_FO">fo_FO</option><option value="fr_CA">fr_CA</option><option value="fr_FR">fr_FR</option><option value="fy_NL">fy_NL</option><option value="ga_IE">ga_IE</option><option value="gl_ES">gl_ES</option><option value="he_IL">he_IL</option><option value="hi_IN">hi_IN</option><option value="hr_HR">hr_HR</option><option value="hu_HU">hu_HU</option><option value="hy_AM">hy_AM</option><option value="id_ID">id_ID</option><option value="is_IS">is_IS</option><option value="it_IT">it_IT</option><option value="ja_JP">ja_JP</option><option value="ka_GE">ka_GE</option><option value="km_KH">km_KH</option><option value="ko_KR">ko_KR</option><option value="ko_KR">ko_KR</option><option value="la_VA">la_VA</option><option value="lt_LT">lt_LT</option><option value="lv_LV">lv_LV</option><option value="mk_MK">mk_MK</option><option value="ml_IN">ml_IN</option><option value="ms_MY">ms_MY</option><option value="nb_NO">nb_NO</option><option value="ne_NP">ne_NP</option><option value="nl_NL">nl_NL</option><option value="nn_NO">nn_NO</option><option value="pa_IN">pa_IN</option><option value="pl_PL">pl_PL</option><option value="ps_AF">ps_AF</option><option value="pt_BR">pt_BR</option><option value="pt_PT">pt_PT</option><option value="ro_RO">ro_RO</option><option value="ru_RU">ru_RU</option><option value="sk_SK">sk_SK</option><option value="sl_SI">sl_SI</option><option value="sq_AL">sq_AL</option><option value="sr_RS">sr_RS</option><option value="sv_SE">sv_SE</option><option value="sw_KE">sw_KE</option><option value="ta_IN">ta_IN</option><option value="th_TH">th_TH</option><option value="tl_PH">tl_PH</option><option value="tr_TR">tr_TR</option><option value="uk_UA">uk_UA</option><option value="vi_VN">vi_VN</option><option value="zh_CN">zh_CN</option><option value="zh_HK">zh_HK</option><option value="zh_TW">zh_TW</option>
      </select>
			
      <input type="submit" value="Post to Frame"/>
		</form>
	</div>
	
</body>


<!-- BEGIN JAVASCRIPT -->
  <script>
  
  document.getElementById('embed_mode').addEventListener('change', function(e){
    document.body.className = e.target.value;
  })
  
    document.getElementById('config-form').addEventListener('submit', function(e){
      e.preventDefault();
    
      // build the data to send
      var signed_request = {
        "expires": Math.round((new Date().getTime() / 1000)+7200),
        "algorithm": "HMAC-SHA256",
        "issued_at": Math.round(new Date().getTime() / 1000),
        "oauth_token": "SOME_EXAMPLE_TOKEN",
        "user_id": document.getElementById('config_user_id').value,
        "user": {
          "country": document.getElementById('config_country').value,
          "locale": document.getElementById('config_locale').value,
          "age": {
            "min": 21
          } 
        }
      };
      
	  // build the payload and signature strings
 	  var payload = encode64(JSON.stringify(signed_request));
	  var app_secret = document.getElementById('config_app_secret').value
	  
	  var sig = HMAC_SHA256_MAC(app_secret, payload);
	  //HMAC_SHA256_init(app_secret);
	  //HMAC_SHA256_write(payload);
	  //var sig = HMAC_SHA256_finalize();
	  
      var signed_request_string = sig + '.' + payload;
      console.log(signed_request_string);
    
      // execute the request
      var post_url = document.getElementById('config_server_url').value + document.getElementById('config_canvas_path').value
      document.getElementById('signed_request').value = signed_request_string;
      var post_form = document.getElementById('post-form')
      post_form.setAttribute('action', post_url)
      post_form.submit();
      
    })
    
    
    var keyStr = "ABCDEFGHIJKLMNOP" +
                   "QRSTUVWXYZabcdef" +
                   "ghijklmnopqrstuv" +
                   "wxyz0123456789+/" + // was "wxyz0123456789+/"
                   "=";
    
    function encode64(input) {
         //input = escape(input); // not needed in this setup
         var output = "";
         var chr1, chr2, chr3 = "";
         var enc1, enc2, enc3, enc4 = "";
         var i = 0;

         do {
            chr1 = input.charCodeAt(i++);
            chr2 = input.charCodeAt(i++);
            chr3 = input.charCodeAt(i++);

            enc1 = chr1 >> 2;
            enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
            enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
            enc4 = chr3 & 63;

            if (isNaN(chr2)) {
               enc3 = enc4 = 64;
            } else if (isNaN(chr3)) {
               enc4 = 64;
            }

            output = output +
               keyStr.charAt(enc1) +
               keyStr.charAt(enc2) +
               keyStr.charAt(enc3) +
               keyStr.charAt(enc4);
            chr1 = chr2 = chr3 = "";
            enc1 = enc2 = enc3 = enc4 = "";
         } while (i < input.length);

         return output;
      }

      function decode64(input) {
         var output = "";
         var chr1, chr2, chr3 = "";
         var enc1, enc2, enc3, enc4 = "";
         var i = 0;

         // remove all characters that are not A-Z, a-z, 0-9, +, /, or =
         var base64test = /[^A-Za-z0-9\+\/\=]/g;
         if (base64test.exec(input)) {
            alert("There were invalid base64 characters in the input text.\n" +
                  "Valid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\n" +
                  "Expect errors in decoding.");
         }
         input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");

         do {
            enc1 = keyStr.indexOf(input.charAt(i++));
            enc2 = keyStr.indexOf(input.charAt(i++));
            enc3 = keyStr.indexOf(input.charAt(i++));
            enc4 = keyStr.indexOf(input.charAt(i++));

            chr1 = (enc1 << 2) | (enc2 >> 4);
            chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
            chr3 = ((enc3 & 3) << 6) | enc4;

            output = output + String.fromCharCode(chr1);

            if (enc3 != 64) {
               output = output + String.fromCharCode(chr2);
            }
            if (enc4 != 64) {
               output = output + String.fromCharCode(chr3);
            }

            chr1 = chr2 = chr3 = "";
            enc1 = enc2 = enc3 = enc4 = "";

         } while (i < input.length);

         return unescape(output);
      }
	  
	  /*
	   *  jssha256 version 0.1  -  Copyright 2006 B. Poettering
	   *
	   *  This program is free software; you can redistribute it and/or
	   *  modify it under the terms of the GNU General Public License as
	   *  published by the Free Software Foundation; either version 2 of the
	   *  License, or (at your option) any later version.
	   *
	   *  This program is distributed in the hope that it will be useful,
	   *  but WITHOUT ANY WARRANTY; without even the implied warranty of
	   *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
	   *  General Public License for more details.
	   *
	   *  You should have received a copy of the GNU General Public License
	   *  along with this program; if not, write to the Free Software
	   *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA
	   *  02111-1307 USA
	   */

	  /*
	   * http://point-at-infinity.org/jssha256/
	   *
	   * This is a JavaScript implementation of the SHA256 secure hash function
	   * and the HMAC-SHA256 message authentication code (MAC).
	   *
	   * The routines' well-functioning has been verified with the test vectors 
	   * given in FIPS-180-2, Appendix B and IETF RFC 4231. The HMAC algorithm 
	   * conforms to IETF RFC 2104. 
	   *
	   * The following code example computes the hash value of the string "abc".
	   *
	   *    SHA256_init();
	   *    SHA256_write("abc");
	   *    digest = SHA256_finalize();  
	   *    digest_hex = array_to_hex_string(digest);
	   * 
	   * Get the same result by calling the shortcut function SHA256_hash:
	   * 
	   *    digest_hex = SHA256_hash("abc");
	   * 
	   * In the following example the calculation of the HMAC of the string "abc" 
	   * using the key "secret key" is shown:
	   * 
	   *    HMAC_SHA256_init("secret key");
	   *    HMAC_SHA256_write("abc");
	   *    mac = HMAC_SHA256_finalize();
	   *    mac_hex = array_to_hex_string(mac);
	   *
	   * Again, the same can be done more conveniently:
	   * 
	   *    mac_hex = HMAC_SHA256_MAC("secret key", "abc");
	   *
	   * Note that the internal state of the hash function is held in global
	   * variables. Therefore one hash value calculation has to be completed 
	   * before the next is begun. The same applies the the HMAC routines.
	   *
	   * Report bugs to: jssha256 AT point-at-infinity.org
	   *
	   */

	  /******************************************************************************/

	  /* Two all purpose helper functions follow */

	  /* string_to_array: convert a string to a character (byte) array */

	  function string_to_array(str) {
	    var len = str.length;
	    var res = new Array(len);
	    for(var i = 0; i < len; i++)
	      res[i] = str.charCodeAt(i);
	    return res;
	  }

	  /* array_to_hex_string: convert a byte array to a hexadecimal string */

	  function array_to_hex_string(ary) {
	    var res = "";
	    for(var i = 0; i < ary.length; i++)
	      res += SHA256_hexchars[ary[i] >> 4] + SHA256_hexchars[ary[i] & 0x0f];
	    return res;
	  }

	  /******************************************************************************/

	  /* The following are the SHA256 routines */

	  /* 
	     SHA256_init: initialize the internal state of the hash function. Call this
	     function before calling the SHA256_write function.
	  */

	  function SHA256_init() {
	    SHA256_H = new Array(0x6a09e667, 0xbb67ae85, 0x3c6ef372, 0xa54ff53a, 
	      0x510e527f, 0x9b05688c, 0x1f83d9ab, 0x5be0cd19);
	    SHA256_buf = new Array();
	    SHA256_len = 0;
	  }

	  /*
	     SHA256_write: add a message fragment to the hash function's internal state. 
	     'msg' may be given as string or as byte array and may have arbitrary length.

	  */

	  function SHA256_write(msg) {
	    if (typeof(msg) == "string")
	      SHA256_buf = SHA256_buf.concat(string_to_array(msg));
	    else
	      SHA256_buf = SHA256_buf.concat(msg);
	    for(var i = 0; i + 64 <= SHA256_buf.length; i += 64)
	      SHA256_Hash_Byte_Block(SHA256_H, SHA256_buf.slice(i, i + 64));
	    SHA256_buf = SHA256_buf.slice(i);
	    SHA256_len += msg.length;
	  }

	  /*
	     SHA256_finalize: finalize the hash value calculation. Call this function
	     after the last call to SHA256_write. An array of 32 bytes (= 256 bits) 
	     is returned.
	  */

	  function SHA256_finalize() {
	    SHA256_buf[SHA256_buf.length] = 0x80;

	    if (SHA256_buf.length > 64 - 8) {
	      for(var i = SHA256_buf.length; i < 64; i++)
	        SHA256_buf[i] = 0;
	      SHA256_Hash_Byte_Block(SHA256_H, SHA256_buf);
	      SHA256_buf.length = 0;
	    }

	    for(var i = SHA256_buf.length; i < 64 - 5; i++)
	      SHA256_buf[i] = 0;
	    SHA256_buf[59] = (SHA256_len >>> 29) & 0xff;
	    SHA256_buf[60] = (SHA256_len >>> 21) & 0xff;
	    SHA256_buf[61] = (SHA256_len >>> 13) & 0xff;
	    SHA256_buf[62] = (SHA256_len >>> 5) & 0xff;
	    SHA256_buf[63] = (SHA256_len << 3) & 0xff;
	    SHA256_Hash_Byte_Block(SHA256_H, SHA256_buf);

	    var res = new Array(32);
	    for(var i = 0; i < 8; i++) {
	      res[4 * i + 0] = SHA256_H[i] >>> 24;
	      res[4 * i + 1] = (SHA256_H[i] >> 16) & 0xff;
	      res[4 * i + 2] = (SHA256_H[i] >> 8) & 0xff;
	      res[4 * i + 3] = SHA256_H[i] & 0xff;
	    }

	    delete SHA256_H;
	    delete SHA256_buf;
	    delete SHA256_len;
	    return res;
	  }

	  /*
	     SHA256_hash: calculate the hash value of the string or byte array 'msg' 
	     and return it as hexadecimal string. This shortcut function may be more 
	     convenient than calling SHA256_init, SHA256_write, SHA256_finalize 
	     and array_to_hex_string explicitly.
	  */

	  function SHA256_hash(msg) {
	    var res;
	    SHA256_init();
	    SHA256_write(msg);
	    res = SHA256_finalize();
	    return array_to_hex_string(res);
	  }

	  /******************************************************************************/

	  /* The following are the HMAC-SHA256 routines */

	  /*
	     HMAC_SHA256_init: initialize the MAC's internal state. The MAC key 'key'
	     may be given as string or as byte array and may have arbitrary length.
	  */

	  function HMAC_SHA256_init(key) {
	    if (typeof(key) == "string")
	      HMAC_SHA256_key = string_to_array(key);
	    else
	      HMAC_SHA256_key = new Array().concat(key);

	    if (HMAC_SHA256_key.length > 64) {
	      SHA256_init();
	      SHA256_write(HMAC_SHA256_key);
	      HMAC_SHA256_key = SHA256_finalize();
	    }

	    for(var i = HMAC_SHA256_key.length; i < 64; i++)
	      HMAC_SHA256_key[i] = 0;
	    for(var i = 0; i < 64; i++)
	      HMAC_SHA256_key[i] ^=  0x36;
	    SHA256_init();
	    SHA256_write(HMAC_SHA256_key);
	  }

	  /*
	     HMAC_SHA256_write: process a message fragment. 'msg' may be given as 
	     string or as byte array and may have arbitrary length.
	  */

	  function HMAC_SHA256_write(msg) {
	    SHA256_write(msg);
	  }

	  /*
	     HMAC_SHA256_finalize: finalize the HMAC calculation. An array of 32 bytes
	     (= 256 bits) is returned.
	  */

	  function HMAC_SHA256_finalize() {
	    var md = SHA256_finalize();
	    for(var i = 0; i < 64; i++)
	      HMAC_SHA256_key[i] ^= 0x36 ^ 0x5c;
	    SHA256_init();
	    SHA256_write(HMAC_SHA256_key);
	    SHA256_write(md);
	    for(var i = 0; i < 64; i++)
	      HMAC_SHA256_key[i] = 0;
	    delete HMAC_SHA256_key;
	    return SHA256_finalize();
	  }

	  /*
	     HMAC_SHA256_MAC: calculate the HMAC value of message 'msg' under key 'key'
	     (both may be of type string or byte array); return the MAC as hexadecimal 
	     string. This shortcut function may be more convenient than calling 
	     HMAC_SHA256_init, HMAC_SHA256_write, HMAC_SHA256_finalize and 
	     array_to_hex_string explicitly.
	  */

	  function HMAC_SHA256_MAC(key, msg) {
	    var res;
	    HMAC_SHA256_init(key);
	    HMAC_SHA256_write(msg);
	    res = HMAC_SHA256_finalize();
	    return array_to_hex_string(res);
	  }

	  /******************************************************************************/

	  /* The following lookup tables and functions are for internal use only! */

	  SHA256_hexchars = new Array('0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 
	    'a', 'b', 'c', 'd', 'e', 'f');

	  SHA256_K = new Array(
	    0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 
	    0x923f82a4, 0xab1c5ed5, 0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 
	    0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174, 0xe49b69c1, 0xefbe4786, 
	    0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da, 
	    0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 
	    0x06ca6351, 0x14292967, 0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 
	    0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85, 0xa2bfe8a1, 0xa81a664b, 
	    0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070, 
	    0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 
	    0x5b9cca4f, 0x682e6ff3, 0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 
	    0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2 
	  );

	  function SHA256_sigma0(x) {
	    return ((x >>> 7) | (x << 25)) ^ ((x >>> 18) | (x << 14)) ^ (x >>> 3);
	  }

	  function SHA256_sigma1(x) {
	    return ((x >>> 17) | (x << 15)) ^ ((x >>> 19) | (x << 13)) ^ (x >>> 10);
	  }

	  function SHA256_Sigma0(x) {
	    return ((x >>> 2) | (x << 30)) ^ ((x >>> 13) | (x << 19)) ^ 
	      ((x >>> 22) | (x << 10));
	  }

	  function SHA256_Sigma1(x) {
	    return ((x >>> 6) | (x << 26)) ^ ((x >>> 11) | (x << 21)) ^ 
	      ((x >>> 25) | (x << 7));
	  }

	  function SHA256_Ch(x, y, z) {
	    return z ^ (x & (y ^ z));
	  }

	  function SHA256_Maj(x, y, z) {
	    return (x & y) ^ (z & (x ^ y));
	  }

	  function SHA256_Hash_Word_Block(H, W) {
	    for(var i = 16; i < 64; i++)
	      W[i] = (SHA256_sigma1(W[i - 2]) +  W[i - 7] + 
	        SHA256_sigma0(W[i - 15]) + W[i - 16]) & 0xffffffff;
	    var state = new Array().concat(H);
	    for(var i = 0; i < 64; i++) {
	      var T1 = state[7] + SHA256_Sigma1(state[4]) + 
	        SHA256_Ch(state[4], state[5], state[6]) + SHA256_K[i] + W[i];
	      var T2 = SHA256_Sigma0(state[0]) + SHA256_Maj(state[0], state[1], state[2]);
	      state.pop();
	      state.unshift((T1 + T2) & 0xffffffff);
	      state[4] = (state[4] + T1) & 0xffffffff;
	    }
	    for(var i = 0; i < 8; i++)
	      H[i] = (H[i] + state[i]) & 0xffffffff;
	  }

	  function SHA256_Hash_Byte_Block(H, w) {
	    var W = new Array(16);
	    for(var i = 0; i < 16; i++)
	      W[i] = w[4 * i + 0] << 24 | w[4 * i + 1] << 16 | 
	        w[4 * i + 2] << 8 | w[4 * i + 3];
	    SHA256_Hash_Word_Block(H, W);
	  }
  
  </script>

</html>

